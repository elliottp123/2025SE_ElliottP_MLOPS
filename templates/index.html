{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Student Grade Prediction</h2>

  <form id="predictionForm">
    <div class="row">
      <!-- Basic Information -->
      <div class="col-md-6 mb-3">
        <h4>Student Information</h4>
        <div class="mb-3">
          <label for="subject" class="form-label">Subject</label>
          <select class="form-select" id="subject" name="subject" required>
            <option value="mathematics">Mathematics</option>
            <option value="portuguese">Portuguese</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="gender" class="form-label">Gender</label>
          <select class="form-select" id="gender" name="gender" required>
            <option value="female">Female</option>
            <option value="male">Male</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="age" class="form-label">Age</label>
          <input
            type="number"
            class="form-control"
            id="age"
            name="age"
            min="15"
            max="22"
            required
          />
        </div>
      </div>

      <!-- Academic Information -->
      <div class="col-md-6 mb-3">
        <h4>Academic Background</h4>
        <div class="mb-3">
          <label for="studytime" class="form-label"
            >Study Time (hours/week)</label
          >
          <select class="form-select" id="studytime" name="studytime" required>
            <option value="1">< 2 hours</option>
            <option value="2">2 to 5 hours</option>
            <option value="3">5 to 10 hours</option>
            <option value="4">> 10 hours</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="failures" class="form-label">Past Failures</label>
          <input
            type="number"
            class="form-control"
            id="failures"
            name="failures"
            min="0"
            max="4"
            required
          />
        </div>
        <div class="mb-3">
          <label for="absences" class="form-label">Absences</label>
          <input
            type="number"
            class="form-control"
            id="absences"
            name="absences"
            min="0"
            max="93"
            required
          />
        </div>
      </div>

      <!-- School Information -->
      <div class="col-md-6 mb-3">
        <h4>School Information</h4>
        <div class="mb-3">
          <label for="school" class="form-label">School</label>
          <select class="form-select" id="school" name="school" required>
            <option value="0">GP</option>
            <option value="1">MS</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="address" class="form-label">Address Type</label>
          <select class="form-select" id="address" name="address" required>
            <option value="0">Urban</option>
            <option value="1">Rural</option>
          </select>
        </div>
      </div>

      <!-- Family Background -->
      <div class="col-md-6 mb-3">
        <h4>Family Background</h4>
        <div class="mb-3">
          <label for="Medu" class="form-label">Mother's Education</label>
          <select class="form-select" id="Medu" name="Medu" required>
            <option value="0">None</option>
            <option value="1">Primary</option>
            <option value="2">5th to 9th Grade</option>
            <option value="3">Secondary</option>
            <option value="4">Higher Education</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="Fedu" class="form-label">Father's Education</label>
          <select class="form-select" id="Fedu" name="Fedu" required>
            <option value="0">None</option>
            <option value="1">Primary</option>
            <option value="2">5th to 9th Grade</option>
            <option value="3">Secondary</option>
            <option value="4">Higher Education</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="famsize" class="form-label">Family Size</label>
          <select class="form-select" id="famsize" name="famsize" required>
            <option value="0">â‰¤ 3</option>
            <option value="1">> 3</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="Pstatus" class="form-label"
            >Parent's Cohabitation Status</label
          >
          <select class="form-select" id="Pstatus" name="Pstatus" required>
            <option value="0">Living Together</option>
            <option value="1">Apart</option>
          </select>
        </div>
      </div>

      <!-- Additional Factors -->
      <div class="col-md-6 mb-3">
        <h4>Additional Factors</h4>
        <div class="mb-3">
          <label for="health" class="form-label">Health Status</label>
          <select class="form-select" id="health" name="health" required>
            <option value="1">Very Bad</option>
            <option value="2">Bad</option>
            <option value="3">Normal</option>
            <option value="4">Good</option>
            <option value="5">Very Good</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="activities" class="form-label"
            >Extra-curricular Activities</label
          >
          <select
            class="form-select"
            id="activities"
            name="activities"
            required
          >
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="freetime" class="form-label"
            >Free Time After School</label
          >
          <select class="form-select" id="freetime" name="freetime" required>
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="goout" class="form-label">Going Out with Friends</label>
          <select class="form-select" id="goout" name="goout" required>
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="romantic" class="form-label"
            >In a Romantic Relationship</label
          >
          <select class="form-select" id="romantic" name="romantic" required>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
      </div>

      <!-- Support and Activities -->
      <div class="col-md-6 mb-3">
        <h4>Support and Activities</h4>
        <div class="mb-3">
          <label for="schoolsup" class="form-label">School Support</label>
          <select class="form-select" id="schoolsup" name="schoolsup" required>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="famsup" class="form-label">Family Support</label>
          <select class="form-select" id="famsup" name="famsup" required>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="paid" class="form-label">Paid Classes</label>
          <select class="form-select" id="paid" name="paid" required>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="nursery" class="form-label">Attended Nursery</label>
          <select class="form-select" id="nursery" name="nursery" required>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="higher" class="form-label">Higher Education Plans</label>
          <select class="form-select" id="higher" name="higher" required>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="internet" class="form-label">Internet Access</label>
          <select class="form-select" id="internet" name="internet" required>
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="famrel" class="form-label"
            >Family Relationship Quality</label
          >
          <select class="form-select" id="famrel" name="famrel" required>
            <option value="1">Very Bad</option>
            <option value="2">Bad</option>
            <option value="3">Normal</option>
            <option value="4">Good</option>
            <option value="5">Excellent</option>
          </select>
        </div>
      </div>

      <!-- Parent's Jobs -->
      <div class="col-md-6 mb-3">
        <h4>Parent's Jobs</h4>
        <div class="mb-3">
          <label for="Mjob" class="form-label">Mother's Job</label>
          <select class="form-select" id="Mjob" name="Mjob" required>
            <option value="at_home">At Home</option>
            <option value="health">Health</option>
            <option value="other">Other</option>
            <option value="services">Services</option>
            <option value="teacher">Teacher</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="Fjob" class="form-label">Father's Job</label>
          <select class="form-select" id="Fjob" name="Fjob" required>
            <option value="at_home">At Home</option>
            <option value="health">Health</option>
            <option value="other">Other</option>
            <option value="services">Services</option>
            <option value="teacher">Teacher</option>
          </select>
        </div>
      </div>

      <!-- Study and Travel Time -->
      <div class="col-md-6 mb-3">
        <h4>Study and Travel Information</h4>
        <div class="mb-3">
          <label for="traveltime" class="form-label"
            >Travel Time to School</label
          >
          <select
            class="form-select"
            id="traveltime"
            name="traveltime"
            required
          >
            <option value="1">< 15 min</option>
            <option value="2">15-30 min</option>
            <option value="3">30-60 min</option>
            <option value="4">> 60 min</option>
          </select>
        </div>
      </div>

      <!-- Alcohol Consumption -->
      <div class="col-md-6 mb-3">
        <h4>Personal Habits</h4>
        <div class="mb-3">
          <label for="Dalc" class="form-label"
            >Workday Alcohol Consumption</label
          >
          <select class="form-select" id="Dalc" name="Dalc" required>
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="Walc" class="form-label"
            >Weekend Alcohol Consumption</label
          >
          <select class="form-select" id="Walc" name="Walc" required>
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>
        </div>
      </div>

      <!-- Previous Grades -->
      <div class="col-md-6 mb-3">
        <h4>Previous Grades</h4>
        <div class="mb-3">
          <label for="G1" class="form-label">First Period Grade (G1)</label>
          <input
            type="number"
            class="form-control"
            id="G1"
            name="G1"
            min="0"
            max="20"
            step="0.1"
            required
          />
        </div>
        <div class="mb-3">
          <label for="G2" class="form-label">Second Period Grade (G2)</label>
          <input
            type="number"
            class="form-control"
            id="G2"
            name="G2"
            min="0"
            max="20"
            step="0.1"
            required
          />
        </div>
      </div>

      <!-- Prediction Type -->
      <div class="col-md-6 mb-3">
        <h4>Prediction Type</h4>
        <div class="mb-3">
          <label for="prediction_type" class="form-label"
            >Select Grade Period to Predict</label
          >
          <select
            class="form-select"
            id="prediction_type"
            name="prediction_type"
            required
          >
            <option value="G1">First Period (G1)</option>
            <option value="G2">Second Period (G2)</option>
            <option value="G3">Final Grade (G3)</option>
          </select>
        </div>
      </div>

      <!-- Additional Information -->
      <div class="col-md-6 mb-3">
        <h4>Additional Information</h4>

        <div class="mb-3">
          <label for="reason" class="form-label"
            >Reason for Choosing School</label
          >
          <select class="form-select" id="reason" name="reason" required>
            <option value="course">Course Preference</option>
            <option value="home">Close to Home</option>
            <option value="reputation">School Reputation</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="guardian" class="form-label">Primary Guardian</label>
          <select class="form-select" id="guardian" name="guardian" required>
            <option value="mother">Mother</option>
            <option value="father">Father</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Predict Grades</button>
  </form>

  <!-- Results Section -->
  <div id="results" class="mt-4" style="display: none">
    <h3>Predicted Grades</h3>
    <div class="row">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">First Period (G1)</h5>
            <p class="card-text" id="g1-prediction"></p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Second Period (G2)</h5>
            <p class="card-text" id="g2-prediction"></p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Final Grade (G3)</h5>
            <p class="card-text" id="g3-prediction"></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document
    .getElementById("predictionForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      // Helper functions
      const normalize = (value, min, max) =>
        (Number(value) - min) / (max - min);
      const boolToInt = (value) =>
        Number(value === true || value === "yes" || value === "1");

      // Create data object in exact training set order
      const data = {
        // Create object with keys in exact order matching training data
        school: Number(formData.get("school")),
        sex: Number(formData.get("gender") === "female" ? 0 : 1),
        age: normalize(formData.get("age"), 15, 22),
        address: Number(formData.get("address")),
        famsize: Number(formData.get("famsize")),
        Pstatus: Number(formData.get("Pstatus")),
        Medu: Number(formData.get("Medu")) / 4.0,
        Fedu: Number(formData.get("Fedu")) / 4.0,
        traveltime: (Number(formData.get("traveltime")) - 1) / 3.0,
        studytime: (Number(formData.get("studytime")) - 1) / 3.0,
        failures: Number(formData.get("failures")) / 4.0,
        schoolsup: Number(formData.get("schoolsup")),
        famsup: Number(formData.get("famsup")),
        paid: Number(formData.get("paid")),
        activities: Number(formData.get("activities") === "yes"),
        nursery: Number(formData.get("nursery")),
        higher: Number(formData.get("higher")),
        internet: Number(formData.get("internet")),
        romantic: Number(formData.get("romantic")),
        famrel: (Number(formData.get("famrel")) - 1) / 4.0,
        freetime: (Number(formData.get("freetime")) - 1) / 4.0,
        goout: (Number(formData.get("goout")) - 1) / 4.0,
        Dalc: (Number(formData.get("Dalc")) - 1) / 4.0,
        Walc: (Number(formData.get("Walc")) - 1) / 4.0,
        health: (Number(formData.get("health")) - 1) / 4.0,
        absences: Number(formData.get("absences")) / 93.0,
        Mjob_at_home: Number(formData.get("Mjob") === "at_home"),
        Mjob_health: Number(formData.get("Mjob") === "health"),
        Mjob_other: Number(formData.get("Mjob") === "other"),
        Mjob_services: Number(formData.get("Mjob") === "services"),
        Mjob_teacher: Number(formData.get("Mjob") === "teacher"),
        Fjob_at_home: Number(formData.get("Fjob") === "at_home"),
        Fjob_health: Number(formData.get("Fjob") === "health"),
        Fjob_other: Number(formData.get("Fjob") === "other"),
        Fjob_services: Number(formData.get("Fjob") === "services"),
        Fjob_teacher: Number(formData.get("Fjob") === "teacher"),
        reason_course: Number(formData.get("reason") === "course"),
        reason_home: Number(formData.get("reason") === "home"),
        reason_other: Number(formData.get("reason") === "other"),
        reason_reputation: Number(formData.get("reason") === "reputation"),
        guardian_father: Number(formData.get("guardian") === "father"),
        guardian_mother: Number(formData.get("guardian") === "mother"),
        guardian_other: Number(formData.get("guardian") === "other"),
        Gvg: 0.0,
        Avgalc:
          (Number(formData.get("Dalc")) + Number(formData.get("Walc"))) / 10.0,
        Bum:
          ((2.0 * Number(formData.get("failures"))) / 4.0 +
            (1.5 * Number(formData.get("absences"))) / 93.0 +
            Number(formData.get("Dalc")) / 5.0 +
            Number(formData.get("Walc")) / 5.0 +
            (4.0 - Number(formData.get("studytime"))) / 4.0 +
            (0.5 * Number(formData.get("freetime"))) / 5.0) /
          6.0,
        // Add G1 and G2 values directly in the base data object
        G1: Number(formData.get("G1")) || 0,
        G2: Number(formData.get("G2")) || 0,
      };

      // Add prediction type and other metadata
      const metadata = {
        subject: formData.get("subject") || "mathematics",
        gender: formData.get("gender") || "female",
        prediction_type: formData.get("prediction_type") || "G3",
      };

      // Combine data with metadata
      const requestData = { ...data, ...metadata };

      // Debug logging
      console.log("Sending G1:", requestData.G1, "G2:", requestData.G2);

      try {
        const response = await fetch("/api/predict", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestData),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Prediction failed");
        }

        const result = await response.json();
        console.log("Received result:", result);

        // Display results
        document.getElementById("results").style.display = "block";
        document.getElementById(
          "g3-prediction"
        ).textContent = `${result.predictions.G3.toFixed(2)}`;

        // Also display provided G1/G2 values for context
        document.getElementById(
          "g1-prediction"
        ).textContent = `${requestData.G1.toFixed(2)} (provided)`;
        document.getElementById(
          "g2-prediction"
        ).textContent = `${requestData.G2.toFixed(2)} (provided)`;
      } catch (error) {
        console.error("Prediction error:", error);
        alert(error.message);
      }
    });
</script>
{% endblock %}
